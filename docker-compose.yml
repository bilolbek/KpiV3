version: '3.4'

services:
  kpiv3.webapi:
    image: ${DOCKER_REGISTRY-}kpiv3webapi

    build:
      context: .
      dockerfile: src/KpiV3.WebApi/Dockerfile

    environment:
      - ConnectionStrings__Default=Host=database;Port=5432;Database=kpi_db;UserName=kpi_user;Password=kpi_pass
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      
      - Jwt__Issuer=Kpi
      - Jwt__Audience=Kpi
      - Jwt__TokenLifetime=1:00:00
      - Jwt__Secret=TestingPurposesOnlySecretDoNotUseInProductionPlease

      - DataInitialization__Positions__0__Name=Admin
      - DataInitialization__Positions__0__Type=Root

      - DataInitialization__Employees__1__Email=admin@kpi.com
      - DataInitialization__Employees__1__FirstName=Admin
      - DataInitialization__Employees__1__LastName=Adminovich
      - DataInitialization__Employees__1__Position=Admin

      - DataInitialization__RetryCount=5
      - DataInitialization__RetryWait=00:00:10

      - S3__AccessKey=minio_user
      - S3__SecretKey=minio_pass
      - S3__Bucket=kpi
      - S3__Endpoint=http://minio:9000

    ports:
      - 5000:5000

    depends_on:
      - database

  minio:
    image: minio/minio:RELEASE.2021-10-23T03-28-24Z.hotfix.f7ed7b98e
    command: server /data --console-address ":9001"
    container_name: minio
    hostname: minio
    environment:
      - MINIO_ROOT_USER=minio_user
      - MINIO_ROOT_PASSWORD=minio_pass
    ports:
      - 9000:9000
      - 9001:9001

  database:
    image: postgres

    ports:
      - 5432:5432

    volumes:
      - database.volume:/var/lib/postgresql/data

    environment:
      - POSTGRES_USER=kpi_user
      - POSTGRES_PASSWORD=kpi_pass
      - POSTGRES_DB=kpi_db

  flyway:
    image: flyway/flyway

    command: -url=jdbc:postgresql://database/kpi_db -user=kpi_user -password=kpi_pass -connectRetries=10 migrate

    volumes:
      - ./src/flyway/:/flyway/sql 

    depends_on:
      - database

volumes:
  database.volume: